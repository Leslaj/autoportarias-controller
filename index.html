<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPortarias - Central de Controle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-card.info { background: linear-gradient(135deg, #E3F2FD, #BBDEFB); }
        .status-card.success { background: linear-gradient(135deg, #E8F5E8, #C8E6C9); }
        .status-card.warning { background: linear-gradient(135deg, #FFF3E0, #FFE0B2); }
        .status-card.error { background: linear-gradient(135deg, #FFEBEE, #FFCDD2); }
        
        .status-card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
        }
        
        .status-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #1976D2;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        
        .btn.primary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }
        
        .btn.success {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            color: white;
        }
        
        .btn.warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #F44336, #D32F2F);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .portarias-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .portaria-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .portaria-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .portaria-item.pendente { border-left-color: #FF9800; }
        .portaria-item.pronta { border-left-color: #2196F3; }
        .portaria-item.inserindo { border-left-color: #9C27B0; }
        .portaria-item.inserida { border-left-color: #4CAF50; }
        .portaria-item.salva { border-left-color: #607D8B; }
        .portaria-item.erro { border-left-color: #F44336; }
        
        .portaria-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .portaria-titulo {
            font-weight: bold;
            font-size: 1.1em;
            color: #1976D2;
            flex: 1;
        }
        
        .portaria-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pendente { background: #FFF3E0; color: #F57C00; }
        .status-pronta { background: #E3F2FD; color: #1976D2; }
        .status-inserindo { background: #F3E5F5; color: #7B1FA2; }
        .status-inserida { background: #E8F5E8; color: #388E3C; }
        .status-salva { background: #ECEFF1; color: #455A64; }
        .status-erro { background: #FFEBEE; color: #D32F2F; }
        
        .portaria-details {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .portaria-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .logs {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #333;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }
        
        .log-info { color: #00ff00; }
        .log-warning { color: #ffff00; }
        .log-error { color: #ff0000; }
        .log-success { color: #00ffff; }
        
        .instructions {
            background: linear-gradient(135deg, #E8F5E8, #C8E6C9);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #4CAF50;
        }
        
        .instructions h3 {
            color: #2E7D32;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .step {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .step-number {
            background: #4CAF50;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ AutoPortarias - Central de Controle</h1>
            <p>Gerenciamento inteligente de lotes de portarias com sincroniza√ß√£o TRE</p>
        </div>
        
        <div class="content">
            <!-- Status Dashboard -->
            <div class="status-panel">
                <div class="status-card info">
                    <h3>üìÅ Arquivo Estado</h3>
                    <div class="value" id="fileStatus">‚ùì</div>
                </div>
                <div class="status-card success">
                    <h3>üìã Total Portarias</h3>
                    <div class="value" id="totalPortarias">0</div>
                </div>
                <div class="status-card warning">
                    <h3>‚è≥ Pendentes</h3>
                    <div class="value" id="pendentesCount">0</div>
                </div>
                <div class="status-card error">
                    <h3>‚úÖ Processadas</h3>
                    <div class="value" id="processadasCount">0</div>
                </div>
            </div>
            
            <!-- Controles Principais -->
            <div class="controls">
                <button class="btn primary" onclick="lerArquivoEstado()">
                    üìÅ Ler R:\autoportarias_state.json
                </button>
                <button class="btn success" onclick="processarProximaPortaria()" id="btnProxima" disabled>
                    ‚ñ∂Ô∏è Processar Pr√≥xima
                </button>
                <button class="btn warning" onclick="resetarLote()">
                    üîÑ Resetar Lote
                </button>
                <button class="btn danger" onclick="limparLogs()">
                    üóëÔ∏è Limpar Logs
                </button>
            </div>
            
            <!-- Lista de Portarias -->
            <div class="portarias-list">
                <h3>üìù Portarias do Lote Atual</h3>
                <div id="portariasList">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        üöÄ Clique em "Ler R:\autoportarias_state.json" para carregar as portarias
                    </p>
                </div>
            </div>
            
            <!-- Logs -->
            <div>
                <h3>üìä Logs do Sistema</h3>
                <div class="logs" id="logs">
                    <div class="log-entry log-info">
                        <span class="log-timestamp">[00:00:00]</span>
                        Sistema AutoPortarias v4.0 inicializado - Central de Controle GitHub Pages
                    </div>
                    <div class="log-entry log-info">
                        <span class="log-timestamp">[00:00:01]</span>
                        Aguardando carregamento do arquivo de estado...
                    </div>
                </div>
            </div>
            
            <!-- Instru√ß√µes -->
            <div class="instructions">
                <h3>üìã Como Usar a Central de Controle</h3>
                
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Carregue o estado:</strong> Clique em "Ler R:\autoportarias_state.json" para carregar as portarias processadas pela IA
                </div>
                
                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Processe uma por vez:</strong> Clique em "Processar Pr√≥xima" para colocar os dados da pr√≥xima portaria no clipboard
                </div>
                
                <div class="step">
                    <span class="step-number">3</span>
                    <strong>V√° para o TRE:</strong> Abra uma nova aba em <code>https://tambaqui.tre-am.jus.br/.../++add++Ato</code>
                </div>
                
                <div class="step">
                    <span class="step-number">4</span>
                    <strong>Execute o bookmarklet:</strong> No TRE, clique no bookmarklet para inserir automaticamente os dados da portaria
                </div>
                
                <div class="step">
                    <span class="step-number">5</span>
                    <strong>Salve e repita:</strong> Salve a portaria no TRE e volte aqui para processar a pr√≥xima
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global da aplica√ß√£o
        let estadoAtual = null;
        let portariasLote = [];
        let indiceAtual = 0;
        
        // Fun√ß√£o para adicionar logs
        function adicionarLog(tipo, mensagem) {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${tipo}`;
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${mensagem}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Fun√ß√£o para atualizar contadores do dashboard
        function atualizarDashboard() {
            if (!portariasLote.length) {
                document.getElementById('fileStatus').textContent = '‚ùå';
                document.getElementById('totalPortarias').textContent = '0';
                document.getElementById('pendentesCount').textContent = '0';
                document.getElementById('processadasCount').textContent = '0';
                return;
            }
            
            document.getElementById('fileStatus').textContent = '‚úÖ';
            document.getElementById('totalPortarias').textContent = portariasLote.length;
            
            const pendentes = portariasLote.filter(p => p.status !== 'salva').length;
            const processadas = portariasLote.filter(p => p.status === 'salva').length;
            
            document.getElementById('pendentesCount').textContent = pendentes;
            document.getElementById('processadasCount').textContent = processadas;
            
            // Habilita/desabilita bot√£o
            document.getElementById('btnProxima').disabled = pendentes === 0;
        }
        
        // Fun√ß√£o para renderizar lista de portarias
        function renderizarPortarias() {
            const container = document.getElementById('portariasList');
            
            if (!portariasLote.length) {
                container.innerHTML = `
                    <p style="text-align: center; color: #666; padding: 40px;">
                        üìÅ Nenhuma portaria carregada. Clique em "Ler Arquivo" para carregar.
                    </p>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            portariasLote.forEach((portaria, index) => {
                const item = document.createElement('div');
                item.className = `portaria-item ${portaria.status}`;
                
                const statusText = {
                    'pendente': 'Aguardando',
                    'pronta': 'Pronta para inserir',
                    'inserindo': 'Inserindo no TRE',
                    'inserida': 'Inserida no TRE',
                    'salva': 'Salva no TRE',
                    'erro': 'Erro'
                };
                
                item.innerHTML = `
                    <div class="portaria-header">
                        <div class="portaria-titulo">${portaria.titulo}</div>
                        <div class="portaria-status status-${portaria.status}">
                            ${statusText[portaria.status] || portaria.status}
                        </div>
                    </div>
                    <div class="portaria-details">
                        <strong>Ordem:</strong> ${index + 1}/${portariasLote.length}<br>
                        <strong>Ementa:</strong> ${portaria.ementa ? portaria.ementa.substring(0, 100) + '...' : 'N√£o definida'}<br>
                        <strong>√öltima atualiza√ß√£o:</strong> ${portaria.timestamp_ultima_acao || 'N√£o definido'}
                    </div>
                    <div class="portaria-actions">
                        <button class="btn btn-small primary" onclick="processarPortariaEspecifica(${index})" 
                                ${portaria.status === 'salva' ? 'disabled' : ''}>
                            üìã Preparar para TRE
                        </button>
                        <button class="btn btn-small success" onclick="marcarComoSalva(${index})"
                                ${portaria.status === 'salva' ? 'disabled' : ''}>
                            ‚úÖ Marcar como Salva
                        </button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // Fun√ß√£o principal para ler arquivo de estado
        async function lerArquivoEstado() {
            adicionarLog('info', 'üìÅ Tentando ler R:\\autoportarias_state.json...');
            
            try {
                // M√©todo 1: Tentar abrir arquivo em nova janela
                const fileWindow = window.open('file:///R:/autoportarias_state.json', '_blank', 'width=800,height=600');
                
                if (!fileWindow) {
                    throw new Error('Popup bloqueado ou acesso file:// negado');
                }
                
                // Aguarda um pouco para a janela carregar
                setTimeout(async () => {
                    try {
                        // Tenta ler conte√∫do da janela
                        const content = fileWindow.document.body.textContent;
                        fileWindow.close();
                        
                        if (content && content.trim()) {
                            const estado = JSON.parse(content);
                            processarEstadoCarregado(estado);
                        } else {
                            throw new Error('Arquivo vazio ou ileg√≠vel');
                        }
                        
                    } catch (error) {
                        fileWindow.close();
                        adicionarLog('warning', '‚ö†Ô∏è M√©todo direto falhou, tentando m√©todo alternativo...');
                        await lerArquivoAlternativo();
                    }
                }, 2000);
                
            } catch (error) {
                adicionarLog('error', `‚ùå Erro ao acessar arquivo: ${error.message}`);
                await lerArquivoAlternativo();
            }
        }
        
        // M√©todo alternativo via iframe
        async function lerArquivoAlternativo() {
            try {
                adicionarLog('info', 'üîÑ Tentando m√©todo iframe...');
                
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'file:///R:/autoportarias_state.json';
                
                iframe.onload = function() {
                    try {
                        const content = iframe.contentDocument.body.textContent;
                        const estado = JSON.parse(content);
                        document.body.removeChild(iframe);
                        processarEstadoCarregado(estado);
                    } catch (error) {
                        document.body.removeChild(iframe);
                        adicionarLog('error', `‚ùå Erro iframe: ${error.message}`);
                        mostrarFormularioManual();
                    }
                };
                
                iframe.onerror = function() {
                    document.body.removeChild(iframe);
                    adicionarLog('warning', '‚ö†Ô∏è Iframe falhou, solicitando entrada manual...');
                    mostrarFormularioManual();
                };
                
                document.body.appendChild(iframe);
                
                // Timeout de seguran√ßa
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                        mostrarFormularioManual();
                    }
                }, 10000);
                
            } catch (error) {
                adicionarLog('error', `‚ùå Erro m√©todo alternativo: ${error.message}`);
                mostrarFormularioManual();
            }
        }
        
        // Formul√°rio para entrada manual do JSON
        function mostrarFormularioManual() {
            const jsonInput = prompt(`
üîß Acesso autom√°tico ao arquivo falhou!

Por favor, copie e cole o conte√∫do do arquivo:
R:\\autoportarias_state.json

Cole o JSON completo aqui:
            `);
            
            if (jsonInput && jsonInput.trim()) {
                try {
                    const estado = JSON.parse(jsonInput.trim());
                    processarEstadoCarregado(estado);
                } catch (error) {
                    adicionarLog('error', `‚ùå JSON inv√°lido: ${error.message}`);
                    alert('‚ùå JSON inv√°lido! Verifique o formato e tente novamente.');
                }
            } else {
                adicionarLog('warning', '‚ö†Ô∏è Entrada manual cancelada pelo usu√°rio');
            }
        }
        
        // Processa estado carregado com sucesso
        function processarEstadoCarregado(estado) {
            estadoAtual = estado;
            portariasLote = estado.portarias || [];
            indiceAtual = estado.lote_atual?.index_atual || 0;
            
            adicionarLog('success', `‚úÖ Estado carregado: ${portariasLote.length} portarias encontradas`);
            adicionarLog('info', `üìä Lote ID: ${estado.lote_atual?.id || 'N/D'}`);
            adicionarLog('info', `üìã Posi√ß√£o atual: ${indiceAtual + 1}/${portariasLote.length}`);
            
            atualizarDashboard();
            renderizarPortarias();
        }
        
        // Processa pr√≥xima portaria da fila
        function processarProximaPortaria() {
            const proximaPendente = portariasLote.find(p => p.status !== 'salva');
            
            if (!proximaPendente) {
                adicionarLog('warning', '‚ö†Ô∏è Nenhuma portaria pendente encontrada');
                alert('üéâ Todas as portarias foram processadas!');
                return;
            }
            
            const index = portariasLote.indexOf(proximaPendente);
            processarPortariaEspecifica(index);
        }
        
        // Processa portaria espec√≠fica
        async function processarPortariaEspecifica(index) {
            if (!portariasLote[index]) {
                adicionarLog('error', `‚ùå Portaria ${index + 1} n√£o encontrada`);
                return;
            }
            
            const portaria = portariasLote[index];
            portaria.status = 'pronta';
            portaria.timestamp_ultima_acao = new Date().toISOString();
            
            // Dados para o clipboard (formato para bookmarklet do TRE)
            const dadosParaTRE = {
                tipo: 'portaria_individual',
                timestamp: new Date().toISOString(),
                fonte: 'github_controller',
                dados: {
                    titulo: portaria.titulo,
                    ementa: portaria.ementa,
                    conteudo: portaria.conteudo,
                    referencia: portaria.referencia,
                    link: portaria.link,
                    ordem: index + 1,
                    total: portariasLote.length,
                    lote_id: estadoAtual.lote_atual?.id
                }
            };
            
            try {
                await navigator.clipboard.writeText(JSON.stringify(dadosParaTRE, null, 2));
                
                adicionarLog('success', `‚úÖ Portaria ${index + 1} preparada no clipboard`);
                adicionarLog('info', `üìã T√≠tulo: ${portaria.titulo}`);
                adicionarLog('info', 'üöÄ Agora v√° para o TRE e execute o bookmarklet!');
                
                // Atualiza UI
                atualizarDashboard();
                renderizarPortarias();
                
                // Notifica√ß√£o visual
                alert(`‚úÖ Portaria ${index + 1}/${portariasLote.length} est√° pronta!

üìã Dados colocados no clipboard
üöÄ Pr√≥ximo passo: Abra o TRE e execute o bookmarklet

T√≠tulo: ${portaria.titulo}`);
                
            } catch (error) {
                adicionarLog('error', `‚ùå Erro ao copiar para clipboard: ${error.message}`);
                alert('‚ùå Erro ao acessar clipboard! Verifique as permiss√µes do browser.');
            }
        }
        
        // Marca portaria como salva
        function marcarComoSalva(index) {
            if (!portariasLote[index]) return;
            
            portariasLote[index].status = 'salva';
            portariasLote[index].timestamp_ultima_acao = new Date().toISOString();
            
            adicionarLog('success', `‚úÖ Portaria ${index + 1} marcada como salva no TRE`);
            
            atualizarDashboard();
            renderizarPortarias();
            
            // Verifica se todas foram processadas
            const pendentes = portariasLote.filter(p => p.status !== 'salva').length;
            if (pendentes === 0) {
                adicionarLog('success', 'üéâ LOTE COMPLETO! Todas as portarias foram processadas!');
                alert('üéâ PARAB√âNS!\n\nTodas as portarias do lote foram processadas com sucesso!');
            }
        }
        
        // Resetar lote
        function resetarLote() {
            if (confirm('üîÑ Resetar todo o lote?\n\nIsso marcar√° todas as portarias como pendentes novamente.')) {
                portariasLote.forEach(p => {
                    p.status = 'pendente';
                    p.timestamp_ultima_acao = new Date().toISOString();
                });
                
                indiceAtual = 0;
                
                adicionarLog('warning', 'üîÑ Lote resetado - todas as portarias marcadas como pendentes');
                
                atualizarDashboard();
                renderizarPortarias();
            }
        }
        
        // Limpar logs
        function limparLogs() {
            const logs = document.getElementById('logs');
            logs.innerHTML = `
                <div class="log-entry log-info">
                    <span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    Logs limpos - Sistema AutoPortarias v4.0 ativo
                </div>
            `;
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            adicionarLog('success', 'üöÄ Central de Controle GitHub Pages carregada');
            adicionarLog('info', 'üìÅ Pronto para carregar arquivo R:\\autoportarias_state.json');
            
            // Tenta carregar automaticamente se arquivo estiver dispon√≠vel
            setTimeout(() => {
                if (confirm('üöÄ AutoPortarias Central de Controle\n\nTentar carregar automaticamente o arquivo R:\\autoportarias_state.json?')) {
                    lerArquivoEstado();
                }
            }, 1000);
        });
    </script>
</body>
</html>
