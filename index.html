<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPortarias Controller - Teste Python</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        
        h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.2em;
        }
        
        .test-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-width: 150px;
        }
        
        .salvar {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .salvar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .finalizar {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }
        
        .finalizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-weight: bold;
            min-height: 20px;
            text-align: center;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .step {
            margin: 10px 0;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .aba-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1000;
        }
        
        .code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="aba-info" id="abaInfo">Aba Principal</div>
    
    <div class="header">
        <h1>üöÄ AutoPortarias Controller</h1>
        <p class="subtitle">Teste de Comunica√ß√£o Python ‚Üî Browser via Clipboard</p>
    </div>
    
    <div class="container">
        <div class="test-section">
            <h3>üéÆ √Årea de Teste</h3>
            
            <div class="buttons">
                <button class="salvar" onclick="salvar()">
                    üíæ SALVAR
                </button>
                
                <button class="finalizar" onclick="finalizar()">
                    üèÅ FINALIZAR
                </button>
            </div>
            
            <!-- Bot√µes de Debug -->
            <div class="buttons" style="margin-top: 15px;">
                <button style="background: #FF9800; color: white; padding: 10px 20px; border-radius: 5px;" 
                        onclick="testClipboard()">
                    üß™ TESTE CLIPBOARD
                </button>
                
                <button style="background: #9C27B0; color: white; padding: 10px 20px; border-radius: 5px;" 
                        onclick="showBrowserInfo()">
                    üîç INFO BROWSER
                </button>
                
                <button style="background: #607D8B; color: white; padding: 10px 20px; border-radius: 5px;" 
                        onclick="toggleDebug()">
                    üìä TOGGLE DEBUG
                </button>
            </div>
            
            <div class="status" id="status">
                Aguardando comando Python...
            </div>
            
            <!-- √Årea de Debug -->
            <div id="debugArea" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display: none;">
                <div style="color: #4CAF50; font-weight: bold; margin-bottom: 10px;">üîç Debug Log (√∫ltimas 10 mensagens):</div>
                <div id="debugLog"></div>
            </div>
        </div>
    </div>
    
    <div class="container instructions">
        <h3>üìã Instru√ß√µes Passo a Passo</h3>
        
        <div class="step">
            <strong>1.</strong> Execute o script Python: <span class="code">python test_monitor.py</span>
        </div>
        
        <div class="step">
            <strong>2.</strong> O Firefox ser√° aberto automaticamente nesta p√°gina
        </div>
        
        <div class="step">
            <strong>3.</strong> Clique em <strong>"SALVAR"</strong> - Python detectar√° e abrir√° nova aba
        </div>
        
        <div class="step">
            <strong>4.</strong> Clique em <strong>"FINALIZAR"</strong> - Python encerrar√° o monitoramento
        </div>
        
        <div class="step">
            <strong>5.</strong> Verifique o console do Python para ver as detec√ß√µes em tempo real
        </div>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Importante:</strong> Esta p√°gina precisa ser servida via HTTPS para acessar o clipboard. 
            GitHub Pages j√° fornece HTTPS automaticamente!
        </div>
    </div>
    
    <div class="container">
        <h3>üîç Como Funciona</h3>
        <p><strong>Clipboard Rotating:</strong> JavaScript atualiza clipboard ‚Üí Python detecta mudan√ßa ‚Üí A√ß√£o autom√°tica</p>
        
        <div style="margin-top: 20px;">
            <div style="display: flex; align-items: center; margin: 10px 0;">
                <span style="background: #4CAF50; padding: 5px 10px; border-radius: 5px; margin-right: 10px;">Browser</span>
                <span>‚Üí Clipboard ‚Üí</span>
                <span style="background: #2196F3; padding: 5px 10px; border-radius: 5px; margin-left: 10px;">Python</span>
            </div>
        </div>
    </div>

    <script>
        // Detecta se √© uma nova aba baseado na URL
        const urlParams = new URLSearchParams(window.location.search);
        const abaNumero = urlParams.get('aba');
        
        if (abaNumero) {
            document.getElementById('abaInfo').textContent = `Aba ${abaNumero}`;
            document.querySelector('.subtitle').textContent = `Aba ${abaNumero} - Nova aba aberta pelo Python!`;
            
            // Feedback especial para novas abas
            const status = document.getElementById('status');
            status.innerHTML = `üéâ <strong>Nova aba ${abaNumero} aberta pelo Python!</strong><br>Continue testando com os bot√µes`;
            status.style.background = 'rgba(76, 175, 80, 0.3)';
        }
        
        async function salvar() {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            
            console.log(`[${timestamp}] üéØ FUN√á√ÉO SALVAR CHAMADA`);
            console.log(`[${timestamp}] üåê Browser: ${navigator.userAgent}`);
            console.log(`[${timestamp}] üìã Clipboard API dispon√≠vel: ${!!navigator.clipboard}`);
            
            addDebugLog('üéØ Fun√ß√£o SALVAR chamada');
            
            try {
                console.log(`[${timestamp}] ‚úçÔ∏è Tentando escrever no clipboard...`);
                addDebugLog('‚úçÔ∏è Escrevendo SALVAR_CLICADO...');
                
                // Tenta escrever no clipboard
                await navigator.clipboard.writeText('SALVAR_CLICADO');
                
                console.log(`[${timestamp}] ‚úÖ Clipboard escrito com sucesso!`);
                addDebugLog('‚úÖ Escrita no clipboard OK');
                
                // Verifica se foi escrito corretamente
                setTimeout(async () => {
                    try {
                        const readBack = await navigator.clipboard.readText();
                        console.log(`[${timestamp}] üìñ Verifica√ß√£o clipboard: '${readBack}'`);
                        
                        if (readBack === 'SALVAR_CLICADO') {
                            console.log(`[${timestamp}] ‚úÖ Clipboard verificado - conte√∫do correto!`);
                            addDebugLog('‚úÖ Verifica√ß√£o: conte√∫do correto');
                        } else {
                            console.log(`[${timestamp}] ‚ö†Ô∏è Clipboard verificado - conte√∫do diferente!`);
                            addDebugLog(`‚ö†Ô∏è Verifica√ß√£o: esperado 'SALVAR_CLICADO', lido '${readBack}'`);
                        }
                    } catch (e) {
                        console.log(`[${timestamp}] ‚ùå Erro na verifica√ß√£o: ${e}`);
                        addDebugLog(`‚ùå Erro verifica√ß√£o: ${e.message}`);
                    }
                }, 100);
                
                // Feedback visual
                status.innerHTML = `‚úÖ <strong>SALVAR enviado! (${timestamp})</strong><br>üîÑ Python detectar√° e abrir√° nova aba...<br><small>Verifique console para debug</small>`;
                status.style.background = 'rgba(76, 175, 80, 0.3)';
                
                // Reset ap√≥s 5 segundos (mais tempo para debug)
                setTimeout(() => {
                    status.innerHTML = 'Comando enviado! Continue testando...';
                    status.style.background = 'rgba(255, 255, 255, 0.1)';
                }, 5000);
                
            } catch (error) {
                console.error(`[${timestamp}] üí• ERRO DETALHADO:`, error);
                console.error(`[${timestamp}] üìù Erro tipo: ${error.name}`);
                console.error(`[${timestamp}] üìù Erro mensagem: ${error.message}`);
                console.error(`[${timestamp}] üìù Stack trace:`, error.stack);
                
                addDebugLog(`üí• ERRO: ${error.name} - ${error.message}`);
                
                status.innerHTML = `‚ùå <strong>Erro no clipboard! (${timestamp})</strong><br>
                                   üîç Tipo: ${error.name}<br>
                                   üìù Msg: ${error.message}<br>
                                   <small>Ver console para detalhes</small>`;
                status.style.background = 'rgba(244, 67, 54, 0.3)';
                
                // Tenta m√©todo alternativo para Firefox
                if (navigator.userAgent.includes('Firefox')) {
                    console.log(`[${timestamp}] ü¶ä Firefox detectado - tentando m√©todo alternativo...`);
                    addDebugLog('ü¶ä Tentando m√©todo Firefox alternativo...');
                    tryFirefoxClipboard();
                }
            }
        }
        
        async function finalizar() {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            
            console.log(`[${timestamp}] üèÅ FUN√á√ÉO FINALIZAR CHAMADA`);
            
            try {
                console.log(`[${timestamp}] ‚úçÔ∏è Escrevendo FINALIZAR_CLICADO...`);
                
                // Coloca mensagem de finaliza√ß√£o no clipboard
                await navigator.clipboard.writeText('FINALIZAR_CLICADO');
                
                console.log(`[${timestamp}] ‚úÖ FINALIZAR escrito com sucesso!`);
                
                // Feedback visual
                status.innerHTML = `üèÅ <strong>FINALIZAR enviado! (${timestamp})</strong><br>‚èπÔ∏è Python encerrar√° o monitoramento...<br><small>Verifique console Python</small>`;
                status.style.background = 'rgba(244, 67, 54, 0.3)';
                
                // Desabilita bot√µes
                document.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });
                
            } catch (error) {
                console.error(`[${timestamp}] üí• ERRO FINALIZAR:`, error);
                
                status.innerHTML = `‚ùå <strong>Erro no clipboard! (${timestamp})</strong><br>üìù ${error.message}`;
                status.style.background = 'rgba(244, 67, 54, 0.3)';
            }
        }
        
        // M√©todo alternativo para Firefox
        function tryFirefoxClipboard() {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ü¶ä Tentando m√©todo alternativo Firefox...`);
            
            try {
                // Tenta usar execCommand (m√©todo legado)
                const textArea = document.createElement('textarea');
                textArea.value = 'SALVAR_CLICADO';
                document.body.appendChild(textArea);
                textArea.select();
                
                const success = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (success) {
                    console.log(`[${timestamp}] ‚úÖ execCommand funcionou!`);
                    
                    const status = document.getElementById('status');
                    status.innerHTML = `‚úÖ <strong>SALVAR via execCommand! (${timestamp})</strong><br>ü¶ä M√©todo Firefox alternativo usado`;
                    status.style.background = 'rgba(76, 175, 80, 0.3)';
                } else {
                    console.log(`[${timestamp}] ‚ùå execCommand falhou`);
                }
                
            } catch (e) {
                console.log(`[${timestamp}] ‚ùå M√©todo alternativo falhou: ${e}`);
            }
        }
        
        // Debug cont√≠nuo do clipboard
        let debugInterval;
        function startClipboardDebug() {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] üîç Iniciando debug cont√≠nuo do clipboard...`);
            
            debugInterval = setInterval(async () => {
                try {
                    const content = await navigator.clipboard.readText();
                    if (content && content.includes('_CLICADO')) {
                        const debugTime = new Date().toLocaleTimeString();
                        console.log(`[${debugTime}] üìã Clipboard atual: '${content}'`);
                    }
                } catch (e) {
                    // Silently ignore para n√£o spammar
                }
            }, 1000);
        }
        
        function stopClipboardDebug() {
            if (debugInterval) {
                clearInterval(debugInterval);
                console.log(`[${new Date().toLocaleTimeString()}] ‚èπÔ∏è Debug cont√≠nuo parado`);
            }
        }
        
        // Inicializa√ß√£o da p√°gina com debug detalhado
        window.addEventListener('load', () => {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] üöÄ P√ÅGINA CARREGADA - INICIANDO DEBUG`);
            console.log(`[${timestamp}] üåê User Agent: ${navigator.userAgent}`);
            console.log(`[${timestamp}] üîí Protocolo: ${window.location.protocol}`);
            console.log(`[${timestamp}] üìã Clipboard API: ${!!navigator.clipboard}`);
            console.log(`[${timestamp}] üîê Secure Context: ${window.isSecureContext}`);
            
            const status = document.getElementById('status');
            
            // Detecta browser
            let browserName = 'Desconhecido';
            if (navigator.userAgent.includes('Chrome')) browserName = 'Chrome';
            else if (navigator.userAgent.includes('Firefox')) browserName = 'Firefox';
            else if (navigator.userAgent.includes('Safari')) browserName = 'Safari';
            else if (navigator.userAgent.includes('Edge')) browserName = 'Edge';
            
            console.log(`[${timestamp}] üéØ Browser detectado: ${browserName}`);
            
            if (!abaNumero) {
                status.innerHTML = `üü¢ <strong>P√°gina carregada!</strong><br>
                                   üéØ Browser: ${browserName}<br>
                                   üìã Clipboard: ${navigator.clipboard ? '‚úÖ Dispon√≠vel' : '‚ùå N√£o dispon√≠vel'}<br>
                                   <small>Execute Python e teste os bot√µes</small>`;
                status.style.background = 'rgba(33, 150, 243, 0.3)';
            }
            
            // Testa clipboard API
            if (!navigator.clipboard) {
                console.log(`[${timestamp}] ‚ö†Ô∏è CLIPBOARD API N√ÉO DISPON√çVEL!`);
                status.innerHTML = `‚ö†Ô∏è <strong>Clipboard API n√£o dispon√≠vel!</strong><br>
                                   üîí Protocolo: ${window.location.protocol}<br>
                                   üåê Secure Context: ${window.isSecureContext}<br>
                                   üí° Use HTTPS ou localhost`;
                status.style.background = 'rgba(255, 152, 0, 0.3)';
            } else {
                console.log(`[${timestamp}] ‚úÖ Clipboard API dispon√≠vel`);
                
                // Testa permiss√µes
                navigator.permissions.query({name: 'clipboard-write'}).then(result => {
                    console.log(`[${timestamp}] üìù Permiss√£o clipboard-write: ${result.state}`);
                }).catch(e => {
                    console.log(`[${timestamp}] ‚ùå Erro ao verificar permiss√µes: ${e}`);
                });
            }
            
            // Inicia debug cont√≠nuo se for Firefox
            if (browserName === 'Firefox') {
                console.log(`[${timestamp}] ü¶ä Firefox detectado - iniciando debug especial`);
                setTimeout(() => {
                    console.log(`[${timestamp}] üîç Iniciando monitoramento Firefox...`);
                }, 2000);
            }
        });
        
        // Fun√ß√µes de debug adicionais
        async function testClipboard() {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] üß™ INICIANDO TESTE COMPLETO DO CLIPBOARD`);
            
            const status = document.getElementById('status');
            status.innerHTML = 'üß™ <strong>Testando clipboard...</strong>';
            status.style.background = 'rgba(255, 152, 0, 0.3)';
            
            try {
                // Teste 1: Escrever
                console.log(`[${timestamp}] üìù Teste 1: Escrevendo...`);
                const testValue = `TESTE_${Date.now()}`;
                await navigator.clipboard.writeText(testValue);
                console.log(`[${timestamp}] ‚úÖ Escrita OK: ${testValue}`);
                
                // Teste 2: Ler de volta
                console.log(`[${timestamp}] üìñ Teste 2: Lendo...`);
                await new Promise(resolve => setTimeout(resolve, 100));
                const readValue = await navigator.clipboard.readText();
                console.log(`[${timestamp}] üìñ Lido: ${readValue}`);
                
                // Teste 3: Comparar
                if (readValue === testValue) {
                    console.log(`[${timestamp}] ‚úÖ TESTE PASSOU! Clipboard funcionando`);
                    status.innerHTML = '‚úÖ <strong>Clipboard funcionando!</strong><br>‚úÖ Escrita e leitura OK';
                    status.style.background = 'rgba(76, 175, 80, 0.3)';
                } else {
                    console.log(`[${timestamp}] ‚ùå TESTE FALHOU! Esperado: ${testValue}, Lido: ${readValue}`);
                    status.innerHTML = '‚ùå <strong>Teste falhou!</strong><br>‚ùå Leitura diferente da escrita';
                    status.style.background = 'rgba(244, 67, 54, 0.3)';
                }
                
            } catch (error) {
                console.log(`[${timestamp}] üí• ERRO NO TESTE: ${error}`);
                status.innerHTML = `‚ùå <strong>Erro no teste!</strong><br>üí• ${error.name}: ${error.message}`;
                status.style.background = 'rgba(244, 67, 54, 0.3)';
            }
            
            // Reset ap√≥s 3 segundos
            setTimeout(() => {
                status.innerHTML = 'Teste conclu√≠do. Continue usando os bot√µes...';
                status.style.background = 'rgba(255, 255, 255, 0.1)';
            }, 3000);
        }
        
        function showBrowserInfo() {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] üîç MOSTRANDO INFO DETALHADA DO BROWSER`);
            
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                clipboard: !!navigator.clipboard,
                secureContext: window.isSecureContext,
                protocol: window.location.protocol,
                host: window.location.host,
                pathname: window.location.pathname
            };
            
            console.table(info);
            
            const status = document.getElementById('status');
            status.innerHTML = `üîç <strong>Info do Browser</strong><br>
                               üåê ${navigator.userAgent.split(' ').pop()}<br>
                               üìã Clipboard: ${navigator.clipboard ? '‚úÖ' : '‚ùå'}<br>
                               üîí Secure: ${window.isSecureContext ? '‚úÖ' : '‚ùå'}<br>
                               <small>Ver console para detalhes completos</small>`;
            status.style.background = 'rgba(33, 150, 243, 0.3)';
        }
        
        let debugEnabled = false;
        function toggleDebug() {
            debugEnabled = !debugEnabled;
            const debugArea = document.getElementById('debugArea');
            
            if (debugEnabled) {
                debugArea.style.display = 'block';
                startClipboardDebug();
                console.log(`[${new Date().toLocaleTimeString()}] üîß Debug visual ATIVADO`);
            } else {
                debugArea.style.display = 'none';
                stopClipboardDebug();
                console.log(`[${new Date().toLocaleTimeString()}] üîß Debug visual DESATIVADO`);
            }
        }
        
        // Log visual para √°rea de debug
        function addDebugLog(message) {
            if (!debugEnabled) return;
            
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '5px';
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
            
            debugLog.appendChild(logEntry);
            
            // Mant√©m apenas √∫ltimas 10 mensagens
            while (debugLog.children.length > 10) {
                debugLog.removeChild(debugLog.firstChild);
            }
            
            // Auto-scroll
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        // Easter egg: detecta Python rodando
        let pythonDetected = false;
        setInterval(async () => {
            if (!pythonDetected) {
                try {
                    const clip = await navigator.clipboard.readText();
                    if (clip === '') {
                        // Primeiro sinal de que Python pode estar rodando
                        pythonDetected = true;
                        const status = document.getElementById('status');
                        status.innerHTML = 'üêç <strong>Python detectado!</strong><br>Pronto para teste...';
                        status.style.background = 'rgba(76, 175, 80, 0.2)';
                    }
                } catch (e) {
                    // Silently ignore
                }
            }
        }, 2000);
    </script>
</body>
</html>
